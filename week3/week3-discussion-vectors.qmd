---
title: "week3-discussion-vectors"
format: html
---

```{r}
library(here)
library(tidyverse)
library(sf)
library(tmap)
```

```{r}
sb_protected_areas <- st_read(here("week3", "data", "cpad_super_units_sb.shp")) |>  
  st_transform("ESRI:102009")

sb_city_boundaries <- st_read(here("week3", "data", "sb_city_boundaries_2003.shp")) |> 
  st_transform("ESRI:102009")

sb_county_boundary <- st_read(here("week3", "data", "sb_county_boundary_2020.shp")) |> 
  st_transform("ESRI:102009")

aves <- st_read(here("week3", "data", "aves_observations_2020_2024.shp")) |> 
  st_transform("ESRI:102009")
```
Find how many bird observations are within protected areas in Santa Barbara County and show how your output differs with a spatial subset versus a spatial join

```{r}
aves_subset <- sb_protected_areas[aves, ] # Subset for only observed in SB county

nrow(aves_subset)
```
```{r}
tm_shape(sb_county_boundary) +
  tm_fill() +
  tm_shape(sb_protected_areas) +
  tm_borders(lwd = 1, col = '#fb8500') +
  tm_fill(col = '#fb8500', alpha = 0.2) +
  tm_shape(aves_subset) +
  tm_dots(col = '#023047')
```

```{r}
aves_join <- st_join(x = aves, y = sb_county_boundary)
nrow(aves_join)
```

```{r}
tm_shape(sb_county_boundary) +
  tm_fill() +
  tm_shape(sb_protected_areas) +
  tm_borders(lwd = 1, col = "#fb8500") +
    tm_fill(col = "#fb8500", alpha = 0.2) +
  tm_shape(aves_join) +
    tm_dots(col = "#023047")
```


Make a 5 km buffer around the protected areas and subset buffered geometries to only those with bird observations

```{r}
# Check sb_protected for units
st_crs(sb_protected_areas)$units 

aves_buffered <- st_buffer(sb_protected_areas, dist = 5000)
```

```{r}
avs_buffered_sub <- aves_buffered[aves, ]
nrow(avs_buffered_sub)
```

```{r}
tm_shape(sb_county_boundary) +
  tm_fill() +
  tm_shape(sb_protected_areas) +
    tm_borders(lwd = 1, col = "#fb8500") +
    tm_fill(col = "#fb8500", alpha = 0.2) +
  tm_shape(avs_buffered_sub) +
  tm_dots(col = "#023047")
```
3. Find PAs within 15km of Goleta
Find the protected areas within 15 km of a city in Santa Barbara County
Hint: Use dplyr::filter() to select a city from sb_city_boundaries

```{r}
# Subset SB county to Goleta
goleta <- sb_city_boundaries |> 
  filter(NAME == "Goleta")

st_crs(goleta)$units  # Check if units are in meters

goleta_buffer_15km <- st_buffer(goleta, dist = 15000) # Create 15 km buffer around Goleta
```

Explore different outputs for #3 with st_intersects(), st_intersection(), and st_within()

```{r}
goleta_PAs_within <- st_within(sb_protected_areas, goleta_buffer_15km)

```

Distance based join 
```{r}
goleta_PAs_join <- st_join(sb_protected_areas, goleta, st_is_within_distance, dist = 15000)
```

3. Find distance between Goleta and Dangermond Preserve
Find the distance between your city of choice and a protected area of your choice, using the geometriesâ€™ edges and the centroid

```{r}
# Subset PA to Dangermond Preserve
dangermond <- sb_protected_areas |>
  dplyr::filter(UNIT_NAME == "Jack and Laura Dangermond Preserve")

danger_dist <- st_distance(goleta, dangermond) # Compute the distance between geometries edges

# Calculate the geometric center
dangermond_centroid <- st_centroid(dangermond)
goleta_centroid <- st_centroid(goleta)

danger_dist_centroid <- st_distance(goleta_centroid, dangermond_centroid) # Compute the distance between geometries edges

# Check if the distance matrices are equal
danger_dist == danger_dist_centroid
```

